#include "dac.h"

#include <stdbool.h>
#include <stdint.h>
#include "inc/hw_gpio.h"
#include "inc/hw_memmap.h"
#include "inc/hw_types.h"
#include "driverlib/gpio.h"
#include "driverlib/epi.h"
#include "driverlib/rom_map.h"
#include "driverlib/sysctl.h"
#include "driverlib/timer.h"
#include "driverlib/rom.h"
#include "inc/tm4c1294ncpdt.h"
#include "utils/uartstdio.h"

const float sin_data[256]={/*256点正弦查找表*/
  0.00000,0.02464,0.04926,0.07385,0.09840,0.12289,0.14730,0.17163,0.19585,0.21995,0.24391,
  0.26773,0.29139,0.31487,0.33816,0.36124,0.38411,0.40674,0.42912,0.45124,0.47309,0.49466,
  0.51592,0.53687,0.55749,0.57777,0.59771,0.61728,0.63647,0.65528,0.67370,0.69170,0.70928,
  0.72643,0.74314,0.75940,0.77520,0.79053,0.80538,0.81974,0.83360,0.84696,0.85980,0.87212,
  0.88391,0.89516,0.90587,0.91603,0.92564,0.93468,0.94315,0.95106,0.95838,0.96512,0.97128,
  0.97685,0.98182,0.98620,0.98998,0.99316,0.99573,0.99771,0.99907,0.99983,0.99998,0.99953,
  0.99846,0.99680,0.99452,0.99164,0.98817,0.98409,0.97941,0.97414,0.96828,0.96183,0.95479,
  0.94718,0.93899,0.93023,0.92091,0.91102,0.90059,0.88960,0.87808,0.86603,0.85344,0.84034,
  0.82673,0.81262,0.79802,0.78293,0.76736,0.75133,0.73484,0.71791,0.70054,0.68275,0.66454,
  0.64593,0.62692,0.60754,0.58779,0.56767,0.54722,0.52643,0.50533,0.48391,0.46220,0.44022,
  0.41796,0.39545,0.37270,0.34973,0.32654,0.30315,0.27958,0.25584,0.23195,0.20791,0.18375,
  0.15948,0.13511,0.11065,0.08613,0.06156,0.03695,0.01232,-0.01232,-0.03695,-0.06156,
  -0.08613,-0.11065,-0.13511,-0.15948,-0.18375,-0.20791,-0.23195,-0.25584,-0.27958,-0.30315,
  -0.32654,-0.34973,-0.37270,-0.39545,-0.41796,-0.44022,-0.46220,-0.48391,-0.50533,-0.52643,
  -0.54722,-0.56767,-0.58779,-0.60754,-0.62692,-0.64593,-0.66454,-0.68275,-0.70054,-0.71791,
  -0.73484,-0.75133,-0.76736,-0.78293,-0.79802,-0.81262,-0.82673,-0.84034,-0.85344,-0.86603,
  -0.87808,-0.88960,-0.90059,-0.91102,-0.92091,-0.93023,-0.93899,-0.94718,-0.95479,-0.96183,
  -0.96828,-0.97414,-0.97941,-0.98409,-0.98817,-0.99164,-0.99452,-0.99680,-0.99846,-0.99953,
  -0.99998,-0.99983,-0.99907,-0.99771,-0.99573,-0.99316,-0.98998,-0.98620,-0.98182,-0.97685,
  -0.97128,-0.96512,-0.95838,-0.95106,-0.94315,-0.93468,-0.92564,-0.91603,-0.90587,-0.89516,
  -0.88391,-0.87212,-0.85980,-0.84696,-0.83360,-0.81974,-0.80538,-0.79053,-0.77520,-0.75940,
  -0.74314,-0.72643,-0.70928,-0.69170,-0.67370,-0.65528,-0.63647,-0.61728,-0.59771,-0.57777,
  -0.55749,-0.53687,-0.51592,-0.49466,-0.47309,-0.45124,-0.42912,-0.40674,-0.38411,-0.36124,
  -0.33816,-0.31487,-0.29139,-0.26773,-0.24391,-0.21995,-0.19585,-0.17163,-0.14730,-0.12289,
  -0.09840,-0.07385,-0.04926,-0.02464,-0.00000};      
 
void DAC_Init()
{
	//CS  ~ PE1  
	//WR  ~ PE2
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOE);
	SysCtlGPIOAHBEnable(SYSCTL_PERIPH_GPIOE);
	GPIOPinTypeGPIOOutput(GPIO_PORTE_BASE, GPIO_PIN_1|GPIO_PIN_2);
	
	/*
		DATA0  ~ PK3
		DATA1  ~ PK2
		DATA2  ~ PK1
		DATA3  ~ PK0
		DATA4  ~ PC7
		DATA5  ~ PC6
		DATA6  ~ PC5
		DATA7  ~ PC4
		DATA8  ~ PA6
		DATA9  ~ PA7
		DATA10 ~ PG1
		DATA11 ~ PG0
	*/
	
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOK);
	SysCtlGPIOAHBEnable(SYSCTL_PERIPH_GPIOK);
	GPIOPinTypeGPIOOutput(GPIO_PORTK_BASE, GPIO_PIN_3|GPIO_PIN_2|GPIO_PIN_1|GPIO_PIN_0);
	
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOC);
	SysCtlGPIOAHBEnable(SYSCTL_PERIPH_GPIOC);
	GPIOPinTypeGPIOOutput(GPIO_PORTC_BASE, GPIO_PIN_7|GPIO_PIN_6|GPIO_PIN_5|GPIO_PIN_4);
	
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOA);
	SysCtlGPIOAHBEnable(SYSCTL_PERIPH_GPIOA);
	GPIOPinTypeGPIOOutput(GPIO_PORTA_BASE, GPIO_PIN_6|GPIO_PIN_7);
	
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOG);
	SysCtlGPIOAHBEnable(SYSCTL_PERIPH_GPIOG);
	GPIOPinTypeGPIOOutput(GPIO_PORTG_BASE, GPIO_PIN_1|GPIO_PIN_0);
	
}

void DAC_Set_Data(uint16_t out)
{
	bool out_buffer[12];
	uint16_t temp;
	for(int i=0;i<12;i++)
	{
		out_buffer[i] = (out<<(4+i))>>15;
	}
	
	GPIOPinWrite(GPIO_PORTG_BASE, GPIO_PIN_0, out_buffer[0]?GPIO_PIN_0:0);  //DATA11
	GPIOPinWrite(GPIO_PORTG_BASE, GPIO_PIN_1, out_buffer[1]?GPIO_PIN_1:0);  //DATA10
	GPIOPinWrite(GPIO_PORTA_BASE, GPIO_PIN_7, out_buffer[2]?GPIO_PIN_7:0);  //DATA9
	GPIOPinWrite(GPIO_PORTA_BASE, GPIO_PIN_6, out_buffer[3]?GPIO_PIN_6:0);  //DATA8
	GPIOPinWrite(GPIO_PORTC_BASE, GPIO_PIN_4, out_buffer[4]?GPIO_PIN_4:0);  //DATA7
	GPIOPinWrite(GPIO_PORTC_BASE, GPIO_PIN_5, out_buffer[5]?GPIO_PIN_5:0);  //DATA6
	GPIOPinWrite(GPIO_PORTC_BASE, GPIO_PIN_6, out_buffer[6]?GPIO_PIN_6:0);  //DATA5
	GPIOPinWrite(GPIO_PORTC_BASE, GPIO_PIN_7, out_buffer[7]?GPIO_PIN_7:0);  //DATA4
	GPIOPinWrite(GPIO_PORTK_BASE, GPIO_PIN_0, out_buffer[8]?GPIO_PIN_0:0);  //DATA3
	GPIOPinWrite(GPIO_PORTK_BASE, GPIO_PIN_1, out_buffer[9]?GPIO_PIN_1:0);  //DATA2
	GPIOPinWrite(GPIO_PORTK_BASE, GPIO_PIN_2, out_buffer[10]?GPIO_PIN_2:0);  //DATA1
	GPIOPinWrite(GPIO_PORTK_BASE, GPIO_PIN_3, out_buffer[11]?GPIO_PIN_3:0);  //DATA0
}

//out = 3.3*out/4096 (0<out<4096)
void DAC_Output(uint16_t out)
{
	//PULL UP CS
	GPIOPinWrite(GPIO_PORTE_BASE, GPIO_PIN_1, GPIO_PIN_1);
	SysCtlDelay(1);
	
	//PULL DOWN WR
	GPIOPinWrite(GPIO_PORTE_BASE, GPIO_PIN_2, 0);
	SysCtlDelay(1);
	
	//PULL DOWN CS
	GPIOPinWrite(GPIO_PORTE_BASE, GPIO_PIN_1, 0);
	SysCtlDelay(1);
	
	//SET DATA0~11
	DAC_Set_Data(out);
	SysCtlDelay(1);
	
	//PULL UP CS
	GPIOPinWrite(GPIO_PORTE_BASE, GPIO_PIN_1, GPIO_PIN_1);
	SysCtlDelay(1);
	
	//PULL up WR
	GPIOPinWrite(GPIO_PORTE_BASE, GPIO_PIN_2, GPIO_PIN_2);
	SysCtlDelay(1);
}

void DAC_Test()
{
	uint16_t i =0;
	uint16_t temp;
	for(;;)
	{
		temp = (uint16_t)(4095.0*(sin_data[i++]+1.0)/2.0);
		UARTprintf("%4d\n",temp);
		DAC_Output(temp);
		if(i==256)i=0;
		SysCtlDelay(100*SysCtlClockGet()/3000);
	}
}
